[{"content":"摘要：一次非常非常难的coredump排查经历！\nOTA3交付阶段，出现多次功能coredump情况，由于项目交付紧急，需要立即成立专项小组分析并解决该问题。\n通常发生coredump情况，系统会存在core文件。但不绝对，如果系统没有设置core文件生成机制，这种情况就需要额外下发debug版本复现压测。\n因此，在存在core文件的情况下，我们可以直接解析core文件，通过core文件定义到具体程序崩溃在哪一行，正常修改该问题即可。注意不同平台的core文件解析方式不一样。\n但是，这次core文件有些特殊，采用的是google的breakpad工具生成mini-core文件，同时由于历史原因编译选项未增加-g选项，导致堆栈信息不全，无法具体定位在哪一行，造成无法确定原因，至于为什么不全开始怀疑时是-g编译选项的原因，但是增加-g后也无效，后面又怀疑-O2影响-g则把-g改为-g3，依然无效，暂时无法解决就搁置了。仅能显示崩溃在libc.so中stl的vector的new_alloctor.h文件的114行以及崩溃的信号SIGSEGV信息，通过前者信息查阅源码知道崩溃在new开辟内存空间，通过后者信息知道本次崩溃是段错误，无效地址。\n从以上信息，我们当时怀疑几个点：第一个点是多线程问题，第二个点是内存踩空，第三个点是内存不够。因此，制定了几个相应行动项，一是增加-g3编译选项和录制top信息并持续压测复现，二是正向代码走读且要求部门专家一起评审，三是回退近期提交代码。\n巧合的是，压测复现一次，我们根据复现日志发现free从2000+M降低到200+M，正好此时进程崩溃，我们误以为是内存不够，我们功能调用new接口失败。但是后面确定cache内存还有4000M+，应该可以继续分配，同时系统正常运行时的free内存也保持在200M+，因此该结论不成立。\n正向走读代码，我们发现几个问题：\n多线程并发问题，原因是一个月前发现该问题并修复，初步怀疑没有修复完全，代码上发现通过unique_lock来实现加锁。但是多个任务去拿该锁时，会拷贝该唯一锁，正常来说同一个任务的互斥量一致，如果已经被锁了，会阻塞任务，但当时分析拷贝操作可能存在先解锁再加锁的情况，可后面测试该操作发现由于编译优化，直接替换，发现无问题。后面还怀疑一种情况，唯一锁可能会构造失败，造成锁失败，从而导致需要try_lock校验一下，但未验证。可惜，后面我们根据复现日志，发现没有函数重入问题，调用关系正常，暂时无法继续。第二怀疑点是接受数据和任务调度是异步关系，二者存在线程安全问题，正向走读代码，所有处理都在任务调度线程，接受数据线程只做状态记录，故也未发现问题。\n1 2 3 4 unique_lock\u0026lt;mutex\u0026gt; a = [this](){ unique_lock\u0026lt;mutex\u0026gt; lck(m_mtx); return lck; }; 移动拷贝风险，常引用传入参数，但是强转其类型，并用移动拷贝参数，造成改变外部数据未空，当外部数据再次使用，可能存在无效风险。\n1 2 3 4 void func(const T\u0026amp; t){ T t = std::cast\u0026lt;T\u0026amp;\u0026gt;(t); m_t = std::move(t); } 运行阶段，vector频繁触发扩充，会导致一定程度加速内存碎片化，如果数据过大可能在某一次扩容的时候没有连续空间出现该问题，但是有一点差异是扩容申请内存失败应该抛std::bad_alloc异常，不捕获的化进程会SIGABRT。同时，扩容底层会有内存空间拷贝影响性能。\n在以上步骤无效的情况下，我们针对以上几个风险点，做了一些正向修复，一是对于vector提前reverse分配内存空间，二是上层调动接口，增加trycatch，尝试捕获stl异常。\n","permalink":"https://yangly0.github.io/posts/output/2025/20250118232106/","summary":"\u003cp\u003e摘要：一次非常非常难的coredump排查经历！\u003c/p\u003e","title":"记录一次coredump排查经历！"},{"content":"摘要：本文介绍了如何通过hugo 快速搭建一个博客网站，然后设置PaperMod 主题，最后构建一个Github自动发布的博客系统。\n0x01 快速开始 1、软件安装：软件包链接Releases · gohugoio/hugo，建议安装带extended的扩展版本。\n1 2 3 4 5 6 # 下载 wget hugo_extended_0.xxx.x_linux-amd64.deb # 安装 sudo dpkg -i hugo_extended_0.xxx.x_linux-amd64.deb # 验证 hugo version 2、博客发布，访问http://localhost:1313/，查看渲染的博客内容。\n1 2 3 4 5 6 7 8 # 创建博客站点，yaml配置方式，默认是toml配置方式 hugo new site blog --format yaml # 进入博客 cd blog # 创建文章 hugo new posts/first_post.md # 博客发布 hugo server --disableFastRender --navigateToChanged --environment pruction --bind 0.0.0.0 0x02 适配主题 1、主题安装，主题库链接hugo-PaperMod，其他主题可以参考themes。\n1 2 3 4 5 6 7 8 9 # 进入博客 cd blog # 下载主题 git init git submodule add --depth=1 https://github.com/adityatelange/hugo-PaperMod.git themes/PaperMod # needed when you reclone your repo (submodules may not get cloned automatically) git submodule update --init --recursive 2、主题适配，参考hugo-PaperMod文档，手动复制config.yml内容到 hugo.yaml，注意提前备份hugo.yaml。\n3、自定义参数，按自己需求，修改hugo.yaml内容的全局配置、菜单配置、页面配置等。\n1 2 3 4 5 6 baseURL: \u0026#34;...\u0026#34; title: \u0026#34;...\u0026#34; copyright: \u0026#34;...\u0026#34; menu: ... 4、数学公式，PaperMod主题不支持公式渲染，需要手动适配，参考PaperMod Math Typesetting。注意，需要在hugo.yaml增加属性math: true。\n5、评论系统，todo。\n0x03 部署博客 参考link，Github个人网页上部署Hugo博客，每次提交内容到博客仓库Blog（Hugo搭建的仓库），博客仓库Blog会同步信息到个人页面仓库xxx.github.io，并发布网页。\n1、增加一个忽略文件.gitignore，目的是屏蔽本地渲染内容同步到远程仓库，内容如下：\n1 2 3 4 5 6 node_modules/ build/ public/ resources/ .hugo_build.lock 2、增加一个发布脚步hugo-blog.sh，目的是本地发布可以运行./hugo-blog.sh，内容如下：\n1 hugo server --disableFastRender --navigateToChanged --environment pruction --bind 0.0.0.0 3、登录Github网站，网页端创建一个==空仓库==，同步本地blog仓库到远程仓库，操作步骤如下：\n1 2 3 4 5 6 7 cd blog # 到站点文件夹 git init git add . git branch -M main # https://github.com/xxx/blog.git 修改为实际远程仓库链接 git remote add origin https://github.com/xxx/blog.git git push -u origin main 4、登录Github网站，创建个人页面xxx.github.io==空仓库==（第一个字段需要和你账号同名），用于构建github pages。\n5、创建Token密钥，选择Github账号，选择Settings，选择Developer Setting，选择Personal access tokens，选择Token(classic)，点击右上角的Generate new token创建密钥，选择Generate new token(classic)，Note为GP_DEPLOY_TOKEN，勾选repo和workflow，点击Generate token生成token密钥。\n6、配置博客Blog仓库的权限，选择Settings，选择Secrets and Variables，选择Actions，点击New repository secret创建密钥，Name写GP_DEPLOY_TOKEN，Secret填写生成的token密钥。\n7、配置博客Blog仓库的同步Action脚步，增加.github/workflows/deploy-hugo.yml文件，需要修改external_repository字段为个人账号，具体内容如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 name: Deploy hugo on: push: branches: - main # Set a branch to deploy pull_request: jobs: deploy: runs-on: ubuntu-latest concurrency: group: ${{ github.workflow }}-${{ github.ref }} steps: - uses: actions/checkout@v3 with: submodules: true fetch-depth: 0 - name: Setup Hugo uses: peaceiris/actions-hugo@v2 with: hugo-version: \u0026#39;latest\u0026#39; extended: true - name: Build run: hugo --minify - name: Deploy uses: peaceiris/actions-gh-pages@v3 with: personal_token: ${{ secrets.GP_DEPLOY_TOKEN }} external_repository: XXX/XXX.github.io publish_branch: main publish_dir: ./public commit_message: ${{ github.event.head_commit.message }} 8、配置博客Blog仓库的主题更新Action脚步，定时更新主题，增加.github/workflows/update-theme.yml文件，具体内容如下：\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 name: Update theme # Controls when the workflow will run on: schedule: # Update theme automatically everyday at 00:00 UTC - cron: \u0026#34;0 0 * * *\u0026#34; # Allows you to run this workflow manually from the Actions tab workflow_dispatch: jobs: Update-PaperMod: runs-on: ubuntu-latest permissions: write-all steps: - name: Check out repository code uses: actions/checkout@v3 with: submodules: true fetch-depth: 0 - name: Update theme run: git submodule update --remote --merge themes/PaperMod - name: Change remote origin run: | git remote remove origin git remote add origin https://github.com/Yangly0/blog.git - name: Commit changes uses: stefanzweifel/git-auto-commit-action@v4 with: branch: main commit_message: \u0026#39;:arrow_up: Chore(theme): update PaperMod version\u0026#39; commit_author: \u0026#39;github-actions[bot] \u0026lt;github-actions[bot]@users.noreply.github.com\u0026gt;\u0026#39; push_options: \u0026#39;--set-upstream\u0026#39; 9、提交deploy-hugo.yml和update-theme.yml远程博客Blog仓库，并自动发布到个人网页xxx.github.io仓库，访问xxx.github.io网站查看个人博客，具体操作如下：\n1 2 3 4 cd blog git add . git commit -m \u0026#34;feat: add workflow\u0026#34; git push origin main 0x04 撰写博客 1、常见文章，即blog/content/posts文件夹下创建md文件完成，然后写入以下内容：\n1 2 3 4 5 6 7 8 9 10 11 12 --- date: \u0026#39;2024-11-24T02:02:24+08:00\u0026#39; draft: false title: \u0026#39;First_post\u0026#39; --- 摘要：abstract \u0026lt;!--more--\u0026gt; ## 标题1 正文 2、设置前置参数，在文章内容前面添加 yaml、toml 或者 json 格式的参数，配置文章相关属性。\n1 2 3 4 5 6 --- date: \u0026#39;2024-11-24T02:02:24+08:00\u0026#39; draft: false title: \u0026#39;First_post\u0026#39; ... --- 3、设置摘要，通过\u0026lt;!--more--\u0026gt;隔离摘要和内容，并且把摘要显示到预览块。\n1 2 3 4 5 摘要：demo \u0026lt;!--more--\u0026gt; 正文 4、博客内容，根据需求，自定义内容。\n5、发布博客，只需要提交到远程仓库，自动发布到个人页面，操作如下：\n1 2 3 git add . git commit -m \u0026#34;feat: add posts\u0026#34; git push origin main 参考","permalink":"https://yangly0.github.io/posts/output/2024/20241123215151/","summary":"\u003cp\u003e摘要：本文介绍了如何通过hugo 快速搭建一个博客网站，然后设置PaperMod 主题，最后构建一个Github自动发布的博客系统。\u003c/p\u003e","title":"如何搭建一个博客系统？"}]